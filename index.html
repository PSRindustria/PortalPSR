<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma"        content="no-cache" />
  <meta http-equiv="Expires"       content="0" />
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="favicon.png" type="image/png">
  <meta property="og:title" content="Portal PSR">
  <meta property="og:description" content="Acesse nosso canal interno com notícias, cardápio, aniversariantes e mais!">
  <meta property="og:image" content="https://i.postimg.cc/6QTrrhr6/thumbnail.jpg">
  <meta property="og:url" content="https://psrindustria.github.io/PortalPSR/">
  <meta property="og:type" content="website">
  <title>PSR Indústria</title>
  <!-- CSS principal -->
  <link rel="stylesheet" href="style.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <!-- MENU (será carregado via JS) -->
  <div id="menu-placeholder"></div>

  <!-- BANNER -->
  <section class="banner" id="inicio">
    <h1>Bem-vindo ao PortalPSR</h1>
    <p id="banner-announcement">Sua Fonte de Informações, Notícias e Recursos.</p>
    <a href="https://psrindustria.github.io/PortalPSR/cardapio.html" class="banner-btn">Cardápio da Semana</a>
  </section>

  <main>
    <!-- Novidades -->
    <section id="novidades" class="section">
      <h2 class="section-title">Novidades</h2>
      <div class="novidades-header">
        <i class="far fa-clock"></i>
        <span id="data-hoje-novidades"></span>
      </div>
      <div id="novidades-container" class="novidades-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Reflexão do Dia -->
    <section id="reflexao-do-dia" class="section">
      <h2 class="section-title">Reflexão do Dia</h2>
      <div id="reflexao-container" class="reflexao-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Aniversariantes -->
    <section id="aniversariantes" class="section">
      <h2 class="section-title">Aniversariantes do Mês</h2>
      <div id="aniversariantes-container" class="aniversariantes-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Férias -->
    <section id="ferias" class="section">
      <h2 class="section-title">Colaboradores em Férias</h2>
      <div class="ferias-container">
        <div id="ferias-grid-container" class="ferias-grid">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <table class="ferias-table">
          <thead>
            <tr>
              <th>Colaborador</th>
              <th>Departamento</th>
              <th>Início</th>
              <th>Retorno</th>
            </tr>
          </thead>
          <tbody id="ferias-tbody">
            <tr><td colspan="4"><div class="loading"><div class="loading-spinner"></div></div></td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- CIPA -->
    <section id="cipa" class="section">
      <h2 class="section-title">CIPA</h2>
      <div id="cipa-container" class="cipa-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>
  </main>

  <!-- FOOTER (será carregado via JS) -->
  <div id="footer-placeholder"></div>

  <!-- SCRIPTS -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // 0) Função para efeito de fogos de artifício - AGORA COM CONTROLE DE VISIBILIDADE
    function spawnFirework(container, isAniversarianteCard = false) {
      // Se a página não estiver visível, não criar fogos
      if (document.hidden) {
        return;
      }

      const rect = container.getBoundingClientRect();
      const centerX = Math.random() * rect.width;
      const centerY = Math.random() * rect.height;
      const colors = ['#FF0000','#00FF00','#0000FF','#FFFF00','#FF00FF','#00FFFF'];
      const particleCount = 30;
      const speedMin = 1;
      const speedMax = 3;
      const gravity  = 0.02;

      for (let i = 0; i < particleCount; i++) {
        const p = document.createElement('div');
        const size = Math.floor(Math.random() * 4) + 3;
        Object.assign(p.style, {
          position: 'absolute',
          width: `${size}px`, height: `${size}px`,
          backgroundColor: colors[Math.floor(Math.random()*colors.length)],
          borderRadius: '50%',
          left: `${centerX - size/2}px`,
          top:  `${centerY - size/2}px`,
          opacity: '1', pointerEvents: 'none', transform: 'scale(1)',
          zIndex: isAniversarianteCard ? '1' : 'auto' // Garantir que fica contido no card
        });
        container.appendChild(p);

        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * (speedMax - speedMin) + speedMin;
        let vx = Math.cos(angle)*speed;
        let vy = Math.sin(angle)*speed;

        (function animate() {
          // Se a página não estiver visível, remover a partícula
          if (document.hidden) {
            container.removeChild(p);
            return;
          }
          
          vy += gravity;
          const x = parseFloat(p.style.left) + vx;
          const y = parseFloat(p.style.top)  + vy;
          p.style.left = `${x}px`;
          p.style.top  = `${y}px`;
          p.style.opacity = parseFloat(p.style.opacity) - 0.010;
          const scale = (parseFloat(p.style.transform.replace(/scale\(|\)/g,''))||1)*0.98;
          p.style.transform = `scale(${scale})`;
          if (parseFloat(p.style.opacity) > 0) {
            requestAnimationFrame(animate);
          } else {
            if (container.contains(p)) {
              container.removeChild(p);
            }
          }
        })();
      }
    }

    // 1) Injeta menu e rodapé
    ['menu','footer'].forEach(file => {
      fetch(`${file}.html`)
        .then(r => r.text())
        .then(html => {
          document.getElementById(`${file}-placeholder`).innerHTML = html;
          if (file==='menu') {
            const toggle = document.getElementById('menu-toggle'),
                  menuEl = document.getElementById('menu');
            if (toggle && menuEl) {
              toggle.addEventListener('click', () => menuEl.classList.toggle('active'));
              menuEl.querySelectorAll('a').forEach(a => a.addEventListener('click', ()=>menuEl.classList.remove('active')));
            }
          }
        });
    });

    // 2) Configura data de hoje
    const hoje = new Date(),
          dia  = hoje.getDate(),
          mes  = hoje.getMonth(),
          ano  = hoje.getFullYear(),
          meses = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'],
          hojePt = `${dia} de ${meses[mes]} de ${ano}`;
    document.getElementById('data-hoje-novidades').textContent = hojePt;

    // 3) Função genérica fetch + cache-buster
    async function fetchData(path) {
      try {
        const res = await fetch(`${path}?t=${Date.now()}`);
        if (!res.ok) throw new Error(res.status);
        return await res.json();
      } catch {
        return null;
      }
    }

    // 4) Renderiza Novidades
    async function renderNovidades() {
      const data = await fetchData('novidades.json'),
            c    = document.getElementById('novidades-container');
      if (!data) {
        c.innerHTML = '<p>Erro ao carregar novidades.</p>';
        return;
      }
      c.innerHTML = '';
      data.forEach(n => {
        c.innerHTML += `
          <div class="novidade-card">
            <div class="novidade-img"><i class="${n.icone}"></i></div>
            <div class="novidade-content">
              <h3>${n.titulo}</h3>
              <div class="novidade-date"><i class="far fa-calendar-alt"></i> ${n.data}</div>
              <p>${n.conteudo||n.resumo}</p>
            </div>
          </div>`;
      });
    }

    // 5) Renderiza Reflexão do Dia
    async function renderReflexao() {
      const data = await fetchData('reflexaododia.json'),
            c    = document.getElementById('reflexao-container');
      if (!data) {
        c.innerHTML = '<p>Erro ao carregar reflexão.</p>';
        return;
      }
      const key = `${String(dia).padStart(2,'0')}/${String(mes+1).padStart(2,'0')}/${ano}`,
            r   = data.find(x => x.data===key);
      c.innerHTML = '';
      if (!r) {
        c.innerHTML = '<p>Sem reflexão para hoje.</p>';
        return;
      }
      const card = document.createElement('div');
      card.className = 'reflexao-card';
      card.innerHTML = `
        <p class="reflexao-frase">"${r.frase}"</p>
        <p class="reflexao-autor">- ${r.autor}</p>
        <p class="reflexao-instrucao">Clique aqui para refletir</p>
        <div class="reflexao-extra">
          <p class="reflexao-texto">${r.reflexao}</p>
          <p class="reflexao-data">Reflexão: ${r.data}</p>
        </div>`;
      const extra = card.querySelector('.reflexao-extra'),
            instr = card.querySelector('.reflexao-instrucao');
      extra.style.display = 'none';
      instr.addEventListener('click', ()=> {
        extra.style.display = extra.style.display==='none' ? 'block' : 'none';
      });
      c.appendChild(card);
    }

    // 6) Renderiza Aniversariantes + fogos
    async function renderAniversariantes() {
      const data      = await fetchData('aniversariantes.json'),
            container = document.getElementById('aniversariantes-container');
      if (!data) {
        container.innerHTML = '<p>Erro ao carregar aniversariantes.</p>';
        return;
      }
      container.innerHTML = '';
      const hojeN = new Date(),
            dStr  = String(hojeN.getDate()).padStart(2,'0'),
            mStr  = String(hojeN.getMonth()+1).padStart(2,'0'),
            nomesMes = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
      
      // Array para armazenar os cards dos aniversariantes do dia
      const cardsAniversariantesDoDia = [];

      data.forEach(a => {
        const [d,m] = a.data.split('/');
        const card = document.createElement('div');
        card.className = 'aniversariante-card';
        
        // Verifica se é aniversariante do dia
        const ehAniversarianteHoje = d === dStr && m === mStr;
        
        if (ehAniversarianteHoje) {
          card.classList.add('destaque-hoje');
          const tw = document.createElement('div');
          tw.className = 'twinkle-lights';
          tw.style.position = 'relative';
          tw.style.overflow = 'hidden';
          tw.style.width = '100%';
          tw.style.height = '100%';
          card.appendChild(tw);
          
          // Armazena os cards para adicionar os fogos depois
          cardsAniversariantesDoDia.push({card, container: tw});
        }
        
        const dataFmt = `${d} de ${nomesMes[Number(m)-1]}`;
        const imgContainer = document.createElement('div');
        imgContainer.className = 'aniversariante-img';
        if (a.imagem) {
          const img = document.createElement('img');
          img.alt = a.nome;
          img.onerror = function() {
            if (a.imagem_fallback) {
              this.onerror = ()=> imgContainer.innerHTML = '<i class="fas fa-birthday-cake"></i>';
              this.src = a.imagem_fallback;
            } else {
              imgContainer.innerHTML = '<i class="fas fa-birthday-cake"></i>';
            }
          };
          img.src = a.imagem;
          imgContainer.appendChild(img);
        } else {
          imgContainer.innerHTML = '<i class="fas fa-birthday-cake"></i>';
        }
        card.appendChild(imgContainer);
        const info = document.createElement('div');
        info.className = 'aniversariante-info';
        info.innerHTML = `
          <h3><i class="fas fa-birthday-cake"></i> ${a.nome}</h3>
          ${a.cargo? `<p>${a.cargo}</p>`: ''}
          <p class="aniversariante-data">${dataFmt}</p>`;
        card.appendChild(info);
        container.appendChild(card);
      });
      
      // Adiciona os fogos de artifício apenas nos cards dos aniversariantes do dia
      if (cardsAniversariantesDoDia.length > 0) {
        // Adiciona um evento para limpar os fogos quando a página ficar invisível
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            cardsAniversariantesDoDia.forEach(({container}) => {
              // Limpa os fogos quando a página fica em segundo plano
              while (container.firstChild) {
                container.removeChild(container.firstChild);
              }
            });
          }
        });
        
        // Configura os fogos apenas para os cards de aniversariante do dia
        cardsAniversariantesDoDia.forEach(({container}) => {
          const fireworkInterval = setInterval(() => {
            // Só cria fogos se a página estiver visível
            if (!document.hidden) {
              spawnFirework(container, true);
            }
          }, 700);
          
          // Limpa o intervalo quando a página é fechada
          window.addEventListener('beforeunload', () => {
            clearInterval(fireworkInterval);
          });
        });
      }
    }

    // 7) Renderiza Férias
    async function renderFerias() {
      const data = await fetchData('ferias.json'),
            grid = document.getElementById('ferias-grid-container'),
            tb   = document.getElementById('ferias-tbody');
      if (!data) {
        grid.innerHTML = tb.innerHTML = '<p>Erro ao carregar férias.</p>';
        return;
      }
      grid.innerHTML = '';
      tb.innerHTML   = '';
      data.forEach(f => {
        grid.innerHTML += `
          <div class="ferias-card">
            <div class="ferias-card-header">
              <i class="fas fa-plane-departure ferias-card-icon"></i>
              <span class="ferias-card-colaborador">${f.colaborador}</span>
            </div>
            <div class="ferias-dates">
              <span class="ferias-card-inicio">${f.inicio}</span>
              <span class="ferias-card-retorno">${f.retorno}</span>
            </div>
            <p class="ferias-card-departamento">${f.departamento}</p>
          </div>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.colaborador}</td>
          <td>${f.departamento}</td>
          <td>${f.inicio}</td>
          <td>${f.retorno}</td>`;
        tb.appendChild(tr);
      });
    }

    // 8) Renderiza CIPA
    async function renderCIPA() {
      const raw = await fetchData('cipa.json'),
            c   = document.getElementById('cipa-container');
      if (!raw) {
        c.innerHTML = '<p>Erro ao carregar CIPA.</p>';
        return;
      }
      c.innerHTML = '';
      const list = Array.isArray(raw) ? raw : Object.values(raw);
      list.forEach(i => {
        c.innerHTML += `
          <div class="cipa-card">
            <div class="cipa-icon"><i class="${i.icone}"></i></div>
            <h3>${i.titulo||i.nome}</h3>
            <p>${i.conteudo||i.cargo_cipa||''}</p>
          </div>`;
      });
    }

    // 9) Atualiza banner de anúncios
    async function updateBannerAnnouncement() {
      const bannerEl = document.getElementById('banner-announcement');
      if (!bannerEl) return;

      const anives = await fetchData('aniversariantes.json') || [];
      const hoje    = new Date();
      const d       = String(hoje.getDate()).padStart(2,'0');
      const m       = String(hoje.getMonth()+1).padStart(2,'0');
      const nomes = anives
        .filter(a => {
          const [ad,am] = a.data.split('/');
          return ad===d && am===m;
        })
        .map(a => a.nome);

      if (nomes.length) {
        const lista = nomes.join(nomes.length>1 ? ' e ' : '');
        bannerEl.textContent = `Hoje é aniversário de ${lista}!`;
        return;
      }

      const feriados = [
        { date: '01/01', name: 'Confraternização Universal' },
        { date: '25/12', name: 'Natal' },
        // adicione mais feriados aqui
      ];
      const hojeStr = `${d}/${m}`;
      const feriado = feriados.find(f => f.date===hojeStr);
      if (feriado) {
        bannerEl.textContent = `Feliz ${feriado.name}!`;
        return;
      }

      bannerEl.textContent = 'Sua Fonte de Informações, Notícias e Recursos.';
    }

    // 10) Dispara todas as renderizações e anúncios
    (async () => {
      await renderNovidades();
      await renderReflexao();
      await renderAniversariantes();
      await renderFerias();
      await renderCIPA();
      await updateBannerAnnouncement();
    })();

    // 11) Removido o código dos fogos aleatórios contínuos em toda a página
  });
  </script>
</body>
</html>
