<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma"        content="no-cache" />
  <meta http-equiv="Expires"       content="0" />
  <title>PSR Ind√∫stria</title>
  <!-- CSS principal -->
  <link rel="stylesheet" href="style.css" />
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    /* Estilos para a tela de pr√©-carregamento */
    #preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }
    
    #preloader.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    .preloader-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      animation: spin 1.5s linear infinite;
      margin-bottom: 20px;
    }
    
    .preloader-text {
      font-size: 18px;
      color: #333;
    }
    
    .preloader-progress {
      width: 80%;
      max-width: 300px;
      height: 10px;
      background-color: #f3f3f3;
      border-radius: 5px;
      margin-top: 20px;
      overflow: hidden;
    }
    
    .preloader-progress-bar {
      height: 100%;
      background-color: #3498db;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Esconde o conte√∫do inicial */
    body > *:not(#preloader) {
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }
    
    body.loaded > *:not(#preloader) {
      opacity: 1;
    }
    
    /* Estilos para tratamento de falhas em imagens */
    img.img-fallback {
      border: 1px dashed #ccc;
      background-color: #f9f9f9;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    img.img-fallback::after {
      content: 'üñºÔ∏è';
      font-size: 24px;
      position: absolute;
    }
    
    /* Debug - Remover em produ√ß√£o */
    .image-debug {
      background-color: rgba(255, 235, 59, 0.2);
      border: 1px solid #FFC107;
      padding: 2px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="preloader">
    <div class="preloader-spinner"></div>
    <div class="preloader-text">Carregando recursos...</div>
    <div class="preloader-progress">
      <div class="preloader-progress-bar" id="progress-bar"></div>
    </div>
  </div>

  <!-- MENU (ser√° carregado via JS) -->
  <div id="menu-placeholder"></div>

  <!-- BANNER -->
  <section class="banner" id="inicio">
    <h1>Bem-vindo √† Intranet PSR Ind√∫stria</h1>
    <p>Sua fonte central de informa√ß√µes, not√≠cias e recursos.</p>
    <a href="https://psrindustria.github.io/PortalPSR/cardapio.html" class="banner-btn">Card√°pio da Semana</a>
  </section>

  <main>
    <!-- Novidades -->
    <section id="novidades" class="section">
      <h2 class="section-title">Novidades</h2>
      <div class="novidades-header">
        <i class="far fa-clock"></i>
        <span id="data-hoje-novidades"></span>
      </div>
      <div id="novidades-container" class="novidades-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Reflex√£o do Dia -->
    <section id="reflexao-do-dia" class="section">
      <h2 class="section-title">Reflex√£o do Dia</h2>
      <div id="reflexao-container" class="reflexao-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Aniversariantes -->
    <section id="aniversariantes" class="section">
      <h2 class="section-title">Aniversariantes do M√™s</h2>
      <div id="aniversariantes-container" class="aniversariantes-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- F√©rias -->
    <section id="ferias" class="section">
      <h2 class="section-title">Colaboradores em F√©rias</h2>
      <div class="ferias-container">
        <div id="ferias-grid-container" class="ferias-grid">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <table class="ferias-table">
          <thead>
            <tr>
              <th>Colaborador</th>
              <th>Departamento</th>
              <th>In√≠cio</th>
              <th>Retorno</th>
            </tr>
          </thead>
          <tbody id="ferias-tbody">
            <tr><td colspan="4"><div class="loading"><div class="loading-spinner"></div></div></td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- CIPA -->
    <section id="cipa" class="section">
      <h2 class="section-title">CIPA</h2>
      <div id="cipa-container" class="cipa-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>
  </main>

  <!-- FOOTER (ser√° carregado via JS) -->
  <div id="footer-placeholder"></div>

  <!-- SCRIPTS -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Vari√°veis para controle do preloader
    const preloader = document.getElementById('preloader');
    const progressBar = document.getElementById('progress-bar');
    const body = document.body;
    let imagesToLoad = [];
    let imagesLoaded = 0;
    
    // 1) Fun√ß√£o para coletar todas as URLs de imagem do site
    async function collectAllImageUrls() {
      // Imagens dos menus e rodap√©
      try {
        const menuHtml = await fetch('menu.html').then(r => r.text());
        const footerHtml = await fetch('footer.html').then(r => r.text());
        
        // Injeta temporariamente no DOM para extrair imagens
        const tempDiv = document.createElement('div');
        tempDiv.style.display = 'none';
        tempDiv.innerHTML = menuHtml + footerHtml;
        document.body.appendChild(tempDiv);
        
        // Coleta URLs de imagens dos elementos injetados
        const menuFooterImages = Array.from(tempDiv.querySelectorAll('img')).map(img => img.src);
        document.body.removeChild(tempDiv);
        
        // Coleta URLs de dados JSON que cont√™m imagens
        const jsonData = await Promise.all([
          fetchData('novidades.json'),
          fetchData('aniversariantes.json'),
          fetchData('ferias.json'),
          fetchData('cipa.json'),
          fetchData('reflexaododia.json') // Adicionando reflex√£o do dia
        ]);
        
        // Extrair URLs de imagens dos dados JSON
        const jsonImages = [];
        
        // Novidades
        if (jsonData[0]) {
          jsonData[0].forEach(item => {
            if (item.imagem) jsonImages.push(item.imagem);
            // Procura por URLs em conte√∫do ou resumo
            if (item.conteudo && item.conteudo.includes('img src=')) {
              const matches = item.conteudo.match(/src=["'](.*?)["']/g);
              if (matches) {
                matches.forEach(match => {
                  const url = match.replace(/src=["'](.*?)["']/, '$1');
                  jsonImages.push(url);
                });
              }
            }
            if (item.resumo && item.resumo.includes('img src=')) {
              const matches = item.resumo.match(/src=["'](.*?)["']/g);
              if (matches) {
                matches.forEach(match => {
                  const url = match.replace(/src=["'](.*?)["']/, '$1');
                  jsonImages.push(url);
                });
              }
            }
          });
        }
        
        // Aniversariantes
        if (jsonData[1]) {
          jsonData[1].forEach(item => {
            if (item.imagem) jsonImages.push(item.imagem);
          });
        }
        
        // Reflex√£o do dia
        if (jsonData[4]) {
          jsonData[4].forEach(item => {
            if (item.imagem) jsonImages.push(item.imagem);
            // Procura por URLs na reflex√£o
            if (item.reflexao && item.reflexao.includes('img src=')) {
              const matches = item.reflexao.match(/src=["'](.*?)["']/g);
              if (matches) {
                matches.forEach(match => {
                  const url = match.replace(/src=["'](.*?)["']/, '$1');
                  jsonImages.push(url);
                });
              }
            }
            // Procura por URLs na frase
            if (item.frase && item.frase.includes('img src=')) {
              const matches = item.frase.match(/src=["'](.*?)["']/g);
              if (matches) {
                matches.forEach(match => {
                  const url = match.replace(/src=["'](.*?)["']/, '$1');
                  jsonImages.push(url);
                });
              }
            }
          });
        }
        
        // Filtra URLs vazias ou inv√°lidas
        const filteredImages = jsonImages
          .filter(url => url && url.trim() !== '' && !url.startsWith('data:'))
          .map(url => {
            // Ensure URL is absolute
            if (url.startsWith('http') || url.startsWith('//')) {
              return url;
            } else {
              // Convert relative to absolute
              return new URL(url, window.location.href).href;
            }
          });
        
        // Retorna todas as URLs de imagem encontradas (removendo duplicatas)
        return [...new Set([...menuFooterImages, ...filteredImages])];
      } catch (error) {
        console.error('Erro ao coletar URLs de imagem:', error);
        return [];
      }
    }
    
    // 2) Fun√ß√£o para pr√©-carregar todas as imagens
    function preloadImages(imageUrls) {
      return new Promise((resolve) => {
        if (imageUrls.length === 0) {
          resolve(); // Nenhuma imagem para carregar
          return;
        }
        
        console.log(`Pr√©-carregando ${imageUrls.length} imagens...`);
        const preloaderText = document.querySelector('.preloader-text');
        
        const totalImages = imageUrls.length;
        let loadedCount = 0;
        let errorCount = 0;
        
        // Lista para armazenar URLs de imagens com problemas
        const problematicImages = [];
        
        const updateProgress = () => {
          loadedCount++;
          const progress = (loadedCount / totalImages) * 100;
          progressBar.style.width = `${progress}%`;
          preloaderText.textContent = `Carregando recursos... ${Math.round(progress)}%`;
          
          if (loadedCount === totalImages) {
            if (problematicImages.length > 0) {
              console.warn('Imagens com problema de carregamento:', problematicImages);
            }
            resolve(); // Todas as imagens foram processadas
          }
        };
        
        imageUrls.forEach((url, index) => {
          setTimeout(() => {
            const img = new Image();
            
            img.onload = () => {
              updateProgress();
            };
            
            img.onerror = () => {
              errorCount++;
              problematicImages.push(url);
              console.warn(`Erro ao carregar imagem: ${url}`);
              updateProgress();
              
              // Tenta carregar com um prefixo alternativo se falhar
              // (Isso ajuda em casos onde as imagens est√£o em um subdiret√≥rio diferente)
              if (!url.includes('/imagens/')) {
                const alternativeUrl = url.startsWith('/') 
                  ? `/imagens${url}` 
                  : `/imagens/${url}`;
                
                const altImg = new Image();
                altImg.src = alternativeUrl;
                // N√£o precisamos esperar pelo evento de carregamento desta segunda tentativa
              }
            };
            
            img.src = url;
          }, index * 50); // Espa√ßamento de 50ms entre tentativas para evitar sobrecarga
        });
      });
    }
    
    // 3) Fun√ß√£o gen√©rica fetch + JSON com cache-buster (j√° existente no seu c√≥digo)
    async function fetchData(path) {
      const cacheBuster = Date.now();
      try {
        const res = await fetch(`${path}?t=${cacheBuster}`);
        if (!res.ok) throw new Error(res.status);
        return await res.json();
      } catch {
        return null;
      }
    }
    
    // 4) Fun√ß√£o para inicializar o site
    async function initSite() {
      try {
        // 4.1) Injeta menu e rodap√©
        await Promise.all(['menu', 'footer'].map(async (file) => {
          const html = await fetch(`${file}.html`).then(r => r.text());
          document.getElementById(`${file}-placeholder`).innerHTML = html;
          
          // Ativa toggle apenas para o menu
          if (file === 'menu') {
            const toggle = document.getElementById('menu-toggle');
            const menuEl = document.getElementById('menu');
            if (toggle && menuEl) {
              // Abre/fecha ao clicar no hamb√∫rguer
              toggle.addEventListener('click', () => {
                menuEl.classList.toggle('active');
              });
              // Fecha o menu ao clicar em qualquer link
              menuEl.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                  menuEl.classList.remove('active');
                });
              });
            }
          }
        }));
        
        // 4.2) Coleta e pr√©-carrega todas as imagens
        const imageUrls = await collectAllImageUrls();
        await preloadImages(imageUrls);
        
        // 4.3) Configura data de hoje
        const hoje = new Date(),
              dia = hoje.getDate(),
              mes = hoje.getMonth(),
              ano = hoje.getFullYear(),
              meses = ['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'],
              hojePt = `${dia} de ${meses[mes]} de ${ano}`;
        document.getElementById('data-hoje-novidades').textContent = hojePt;
        
        // 4.4) Dispara todas as renderiza√ß√µes
        await Promise.all([
          renderNovidades(),
          renderReflexao(),
          renderAniversariantes(),
          renderFerias(),
          renderCIPA()
        ]);
        
        // 4.5) Remove o preloader e exibe o conte√∫do
        setTimeout(() => {
          preloader.classList.add('fade-out');
          body.classList.add('loaded');
          setTimeout(() => {
            preloader.style.display = 'none';
          }, 500);
          
          // 4.6) Adiciona um tratamento global para imagens com erro
          document.addEventListener('error', function(e) {
            if (e.target.tagName.toLowerCase() !== 'img') return;
            
            console.warn(`Imagem com erro: ${e.target.src}`);
            const originalSrc = e.target.src;
            
            // Tente diferentes caminhos alternativos
            const paths = [
              `/imgs${originalSrc.startsWith('/') ? '' : '/'}${originalSrc.split('/').pop()}`,
              `/imagens${originalSrc.startsWith('/') ? '' : '/'}${originalSrc.split('/').pop()}`,
              `imgs/${originalSrc.split('/').pop()}`
            ];
            
            // Tenta o pr√≥ximo caminho
            let pathIndex = 0;
            const tryNextPath = () => {
              if (pathIndex < paths.length) {
                e.target.src = paths[pathIndex];
                pathIndex++;
              } else {
                // Se nenhum caminho funcionar, use um √≠cone adequado
                e.target.style.display = 'none';
                const icon = document.createElement('i');
                icon.className = 'fas fa-image';
                icon.style.fontSize = '2rem';
                icon.style.color = '#ccc';
                e.target.parentNode.appendChild(icon);
              }
            };
            
            e.target.onerror = tryNextPath;
            tryNextPath();
          }, true); // Capture phase
        }, 500);
        
      } catch (error) {
        console.error('Erro na inicializa√ß√£o do site:', error);
        // Em caso de erro, ainda exibe o site
        preloader.classList.add('fade-out');
        body.classList.add('loaded');
      }
    }
    
    // 5) Renderiza Novidades
    async function renderNovidades() {
      const data = await fetchData('novidades.json'),
            c = document.getElementById('novidades-container');
      if (!data) {
        c.innerHTML = '<p>Erro ao carregar novidades.</p>';
        return;
      }
      c.innerHTML = '';
      data.forEach(n => {
        c.innerHTML += `
          <div class="novidade-card">
            <div class="novidade-img"><i class="${n.icone}"></i></div>
            <div class="novidade-content">
              <h3>${n.titulo}</h3>
              <div class="novidade-date"><i class="far fa-calendar-alt"></i> ${n.data}</div>
              <p>${n.conteudo||n.resumo}</p>
            </div>
          </div>`;
      });
    }

    // 6) Renderiza Reflex√£o do Dia
    async function renderReflexao() {
      const data = await fetchData('reflexaododia.json'),
            c = document.getElementById('reflexao-container');
      if (!data) {
        c.innerHTML = '<p>Erro ao carregar reflex√£o.</p>';
        return;
      }
      
      // Cria a data atual no formato correto
      const hoje = new Date();
      const dia = hoje.getDate();
      const mes = hoje.getMonth();
      const ano = hoje.getFullYear();
      const key = `${String(dia).padStart(2,'0')}/${String(mes+1).padStart(2,'0')}/${ano}`;
      
      const r = data.find(x => x.data === key);
      c.innerHTML = '';
      if (!r) {
        c.innerHTML = '<p>Sem reflex√£o para hoje.</p>';
        return;
      }
      
      // Processa a reflex√£o para corrigir poss√≠veis problemas com imagens
      let reflexaoTexto = r.reflexao || '';
      let fraseTexto = r.frase || '';
      
      // Processa poss√≠veis imagens na reflex√£o para adicionar tratamento de erro
      if (reflexaoTexto.includes('img src=')) {
        reflexaoTexto = reflexaoTexto.replace(/<img([^>]*)src=["']([^"']*)["']([^>]*)>/g, 
          (match, p1, src, p2) => {
            return `<img${p1}src="${src}" onerror="this.onerror=null; this.src='/imgs/${src}'; this.classList.add('img-fallback');"${p2}>`;
          }
        );
      }
      
      // Processa poss√≠veis imagens na frase para adicionar tratamento de erro
      if (fraseTexto.includes('img src=')) {
        fraseTexto = fraseTexto.replace(/<img([^>]*)src=["']([^"']*)["']([^>]*)>/g, 
          (match, p1, src, p2) => {
            return `<img${p1}src="${src}" onerror="this.onerror=null; this.src='/imgs/${src}'; this.classList.add('img-fallback');"${p2}>`;
          }
        );
      }
      
      const card = document.createElement('div');
      card.className = 'reflexao-card';
      
      // Usar texto processado com tratamento de imagens
      card.innerHTML = `
        <p class="reflexao-frase">"${fraseTexto}"</p>
        <p class="reflexao-autor">- ${r.autor}</p>
        <p class="reflexao-instrucao">Clique aqui para refletir</p>
        <div class="reflexao-extra">
          <p class="reflexao-texto">${reflexaoTexto}</p>
          <p class="reflexao-data">Reflex√£o: ${r.data}</p>
        </div>`;
        
      const extra = card.querySelector('.reflexao-extra'),
            instr = card.querySelector('.reflexao-instrucao');
      extra.style.display = 'none';
      instr.addEventListener('click', () => {
        extra.style.display = extra.style.display === 'none' ? 'block' : 'none';
      });
      c.appendChild(card);
    }

    // 7) Renderiza Aniversariantes + fogos de artif√≠cio
    async function renderAniversariantes() {
      const data = await fetchData('aniversariantes.json'),
            container = document.getElementById('aniversariantes-container');
      if (!data) {
        container.innerHTML = '<p>Erro ao carregar aniversariantes.</p>';
        return;
      }
      container.innerHTML = '';
      const hoje = new Date(),
            diaHoje = String(hoje.getDate()).padStart(2,'0'),
            mesHoje = String(hoje.getMonth()+1).padStart(2,'0'),
            nomesMes = ['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];

      data.forEach(a => {
        const [dStr,mStr] = a.data.split('/');
        const card = document.createElement('div');
        card.className = 'aniversariante-card';

        // se for hoje, marca e insere zona de fogos
        if (dStr === diaHoje && mStr === mesHoje) {
          card.classList.add('destaque-hoje');
          const tw = document.createElement('div');
          tw.className = 'twinkle-lights';
          card.appendChild(tw);
          setInterval(()=>spawnFirework(tw), 700);
        }

        const dataFmt = `${dStr} de ${nomesMes[Number(mStr)-1]}`;
        
        // Cria o elemento de imagem com tratamento de erro
        const imgElement = document.createElement('div');
        imgElement.className = 'aniversariante-img';
        
        if (a.imagem) {
          const img = document.createElement('img');
          img.alt = a.nome;
          img.src = a.imagem;
          
          // Adiciona tratamento de erro para a imagem
          img.onerror = function() {
            console.warn(`Erro ao carregar imagem do aniversariante: ${a.nome}`);
            // Tenta com prefixo alternativo
            this.src = a.imagem.startsWith('/') 
              ? `/imgs${a.imagem}` 
              : `/imgs/${a.imagem}`;
              
            // Se ainda falhar, use √≠cone
            this.onerror = function() {
              imgElement.innerHTML = '<i class="fas fa-birthday-cake"></i>';
            };
          };
          
          imgElement.appendChild(img);
        } else {
          imgElement.innerHTML = '<i class="fas fa-birthday-cake"></i>';
        }
        
        card.appendChild(imgElement);
        
        // Adiciona as informa√ß√µes do aniversariante
        const infoElement = document.createElement('div');
        infoElement.className = 'aniversariante-info';
        infoElement.innerHTML = `
          <h3><i class="fas fa-birthday-cake"></i> ${a.nome}</h3>
          ${a.cargo ? `<p>${a.cargo}</p>` : ''}
          <p class="aniversariante-data">${dataFmt}</p>
        `;
        
        card.appendChild(infoElement);
        container.appendChild(card);
      });
    }

    // Cria um fogo de artif√≠cio com part√≠culas aleat√≥rias
    function spawnFirework(container) {
      const firework = document.createElement('div');
      firework.className = 'firework';
      firework.style.top  = (20 + Math.random()*60) + '%';
      firework.style.left = (20 + Math.random()*60) + '%';
      container.appendChild(firework);

      const particleCount = 12;
      for (let i = 0; i < particleCount; i++) {
        const p = document.createElement('div');
        p.className = 'firework-particle';
        const angle    = Math.random() * Math.PI * 2;
        const distance = 30 + Math.random()*70;
        p.style.setProperty('--dx', Math.cos(angle)*distance + 'px');
        p.style.setProperty('--dy', Math.sin(angle)*distance + 'px');
        const hue = Math.floor(Math.random()*360);
        const color = `hsl(${hue},100%,60%)`;
        p.style.background = color;
        p.style.boxShadow  = `0 0 8px ${color},0 0 16px ${color}`;
        firework.appendChild(p);
      }

      setTimeout(()=>firework.remove(), 1000);
    }

    // 8) Renderiza F√©rias
    async function renderFerias() {
      const data = await fetchData('ferias.json'),
            grid = document.getElementById('ferias-grid-container'),
            tb   = document.getElementById('ferias-tbody');
      if (!data) {
        grid.innerHTML = tb.innerHTML = '<p>Erro ao carregar f√©rias.</p>';
        return;
      }
      grid.innerHTML = '';
      tb.innerHTML   = '';
      data.forEach(f => {
        grid.innerHTML += `
          <div class="ferias-card">
            <div class="ferias-card-header">
              <i class="fas fa-plane-departure ferias-card-icon"></i>
              <span class="ferias-card-colaborador">${f.colaborador}</span>
            </div>
            <div class="ferias-dates">
              <span class="ferias-card-inicio">${f.inicio}</span>
              <span class="ferias-card-retorno">${f.retorno}</span>
            </div>
            <p class="ferias-card-departamento">${f.departamento}</p>
          </div>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.colaborador}</td>
          <td>${f.departamento}</td>
          <td>${f.inicio}</td>
          <td>${f.retorno}</td>`;
        tb.appendChild(tr);
      });
    }

    // 9) Renderiza CIPA
    async function renderCIPA() {
      const raw = await fetchData('cipa.json'),
            c = document.getElementById('cipa-container');
      if (!raw) {
        c.innerHTML = '<p>Erro ao carregar CIPA.</p>';
        return;
      }
      c.innerHTML = '';
      const list = Array.isArray(raw) ? raw : Object.values(raw);
      list.forEach(i => {
        c.innerHTML += `
          <div class="cipa-card">
            <div class="cipa-icon"><i class="${i.icone}"></i></div>
            <h3>${i.titulo||i.nome}</h3>
            <p>${i.conteudo||i.cargo_cipa||''}</p>
          </div>`;
      });
    }

    // Inicializa o site com preloader
    initSite();
  });
  </script>
</body>
</html>
