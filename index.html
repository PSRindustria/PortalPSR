<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma"        content="no-cache" />
  <meta http-equiv="Expires"       content="0" />
  <title>PSR Indústria</title>
  <!-- CSS principal -->
  <link rel="stylesheet" href="style.css" />
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    /* Estilos para a tela de pré-carregamento */
    #preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }
    
    #preloader.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    .preloader-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      animation: spin 1.5s linear infinite;
      margin-bottom: 20px;
    }
    
    .preloader-text {
      font-size: 18px;
      color: #333;
    }
    
    .preloader-progress {
      width: 80%;
      max-width: 300px;
      height: 10px;
      background-color: #f3f3f3;
      border-radius: 5px;
      margin-top: 20px;
      overflow: hidden;
    }
    
    .preloader-progress-bar {
      height: 100%;
      background-color: #3498db;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Esconde o conteúdo inicial */
    body > *:not(#preloader) {
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }
    
    body.loaded > *:not(#preloader) {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="preloader">
    <div class="preloader-spinner"></div>
    <div class="preloader-text">Carregando recursos...</div>
    <div class="preloader-progress">
      <div class="preloader-progress-bar" id="progress-bar"></div>
    </div>
  </div>

  <!-- MENU (será carregado via JS) -->
  <div id="menu-placeholder"></div>

  <!-- BANNER -->
  <section class="banner" id="inicio">
    <h1>Bem-vindo à Intranet PSR Indústria</h1>
    <p>Sua fonte central de informações, notícias e recursos.</p>
    <a href="https://psrindustria.github.io/PortalPSR/cardapio.html" class="banner-btn">Cardápio da Semana</a>
  </section>

  <main>
    <!-- Novidades -->
    <section id="novidades" class="section">
      <h2 class="section-title">Novidades</h2>
      <div class="novidades-header">
        <i class="far fa-clock"></i>
        <span id="data-hoje-novidades"></span>
      </div>
      <div id="novidades-container" class="novidades-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Reflexão do Dia -->
    <section id="reflexao-do-dia" class="section">
      <h2 class="section-title">Reflexão do Dia</h2>
      <div id="reflexao-container" class="reflexao-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Aniversariantes -->
    <section id="aniversariantes" class="section">
      <h2 class="section-title">Aniversariantes do Mês</h2>
      <div id="aniversariantes-container" class="aniversariantes-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Férias -->
    <section id="ferias" class="section">
      <h2 class="section-title">Colaboradores em Férias</h2>
      <div class="ferias-container">
        <div id="ferias-grid-container" class="ferias-grid">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <table class="ferias-table">
          <thead>
            <tr>
              <th>Colaborador</th>
              <th>Departamento</th>
              <th>Início</th>
              <th>Retorno</th>
            </tr>
          </thead>
          <tbody id="ferias-tbody">
            <tr><td colspan="4"><div class="loading"><div class="loading-spinner"></div></div></td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- CIPA -->
    <section id="cipa" class="section">
      <h2 class="section-title">CIPA</h2>
      <div id="cipa-container" class="cipa-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>
  </main>

  <!-- FOOTER (será carregado via JS) -->
  <div id="footer-placeholder"></div>

  <!-- SCRIPTS -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Variáveis para controle do preloader
    const preloader = document.getElementById('preloader');
    const progressBar = document.getElementById('progress-bar');
    const body = document.body;
    let imagesToLoad = [];
    let imagesLoaded = 0;
    
    // 1) Função para coletar todas as URLs de imagem do site
    async function collectAllImageUrls() {
      // Imagens dos menus e rodapé
      try {
        const menuHtml = await fetch('menu.html').then(r => r.text());
        const footerHtml = await fetch('footer.html').then(r => r.text());
        
        // Injeta temporariamente no DOM para extrair imagens
        const tempDiv = document.createElement('div');
        tempDiv.style.display = 'none';
        tempDiv.innerHTML = menuHtml + footerHtml;
        document.body.appendChild(tempDiv);
        
        // Coleta URLs de imagens dos elementos injetados
        const menuFooterImages = Array.from(tempDiv.querySelectorAll('img')).map(img => img.src);
        document.body.removeChild(tempDiv);
        
        // Coleta URLs de dados JSON que contêm imagens
        const jsonData = await Promise.all([
          fetchData('novidades.json'),
          fetchData('aniversariantes.json'),
          fetchData('ferias.json'),
          fetchData('cipa.json')
        ]);
        
        // Extrair URLs de imagens dos dados JSON
        const jsonImages = [];
        
        // Novidades
        if (jsonData[0]) {
          jsonData[0].forEach(item => {
            if (item.imagem) jsonImages.push(item.imagem);
          });
        }
        
        // Aniversariantes
        if (jsonData[1]) {
          jsonData[1].forEach(item => {
            if (item.imagem) jsonImages.push(item.imagem);
          });
        }
        
        // Retorna todas as URLs de imagem encontradas
        return [...menuFooterImages, ...jsonImages];
      } catch (error) {
        console.error('Erro ao coletar URLs de imagem:', error);
        return [];
      }
    }
    
    // 2) Função para pré-carregar todas as imagens
    function preloadImages(imageUrls) {
      return new Promise((resolve) => {
        if (imageUrls.length === 0) {
          resolve(); // Nenhuma imagem para carregar
          return;
        }
        
        const totalImages = imageUrls.length;
        let loadedCount = 0;
        
        imageUrls.forEach(url => {
          const img = new Image();
          
          img.onload = img.onerror = () => {
            loadedCount++;
            const progress = (loadedCount / totalImages) * 100;
            progressBar.style.width = `${progress}%`;
            
            if (loadedCount === totalImages) {
              resolve(); // Todas as imagens foram carregadas
            }
          };
          
          img.src = url;
        });
      });
    }
    
    // 3) Função genérica fetch + JSON com cache-buster (já existente no seu código)
    async function fetchData(path) {
      const cacheBuster = Date.now();
      try {
        const res = await fetch(`${path}?t=${cacheBuster}`);
        if (!res.ok) throw new Error(res.status);
        return await res.json();
      } catch {
        return null;
      }
    }
    
    // 4) Função para inicializar o site
    async function initSite() {
      try {
        // 4.1) Injeta menu e rodapé
        await Promise.all(['menu', 'footer'].map(async (file) => {
          const html = await fetch(`${file}.html`).then(r => r.text());
          document.getElementById(`${file}-placeholder`).innerHTML = html;
          
          // Ativa toggle apenas para o menu
          if (file === 'menu') {
            const toggle = document.getElementById('menu-toggle');
            const menuEl = document.getElementById('menu');
            if (toggle && menuEl) {
              // Abre/fecha ao clicar no hambúrguer
              toggle.addEventListener('click', () => {
                menuEl.classList.toggle('active');
              });
              // Fecha o menu ao clicar em qualquer link
              menuEl.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                  menuEl.classList.remove('active');
                });
              });
            }
          }
        }));
        
        // 4.2) Coleta e pré-carrega todas as imagens
        const imageUrls = await collectAllImageUrls();
        await preloadImages(imageUrls);
        
        // 4.3) Configura data de hoje
        const hoje = new Date(),
              dia = hoje.getDate(),
              mes = hoje.getMonth(),
              ano = hoje.getFullYear(),
              meses = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'],
              hojePt = `${dia} de ${meses[mes]} de ${ano}`;
        document.getElementById('data-hoje-novidades').textContent = hojePt;
        
        // 4.4) Dispara todas as renderizações
        await Promise.all([
          renderNovidades(),
          renderReflexao(),
          renderAniversariantes(),
          renderFerias(),
          renderCIPA()
        ]);
        
        // 4.5) Remove o preloader e exibe o conteúdo
        setTimeout(() => {
          preloader.classList.add('fade-out');
          body.classList.add('loaded');
          setTimeout(() => {
            preloader.style.display = 'none';
          }, 500);
        }, 500);
        
      } catch (error) {
        console.error('Erro na inicialização do site:', error);
        // Em caso de erro, ainda exibe o site
        preloader.classList.add('fade-out');
        body.classList.add('loaded');
      }
    }
    
    // 5) Renderiza Novidades
    async function renderNovidades() {
      const data = await fetchData('novidades.json'),
            c = document.getElementById('novidades-container');
      if (!data) {
        c.innerHTML = '<p>Erro ao carregar novidades.</p>';
        return;
      }
      c.innerHTML = '';
      data.forEach(n => {
        c.innerHTML += `
          <div class="novidade-card">
            <div class="novidade-img"><i class="${n.icone}"></i></div>
            <div class="novidade-content">
              <h3>${n.titulo}</h3>
              <div class="novidade-date"><i class="far fa-calendar-alt"></i> ${n.data}</div>
              <p>${n.conteudo||n.resumo}</p>
            </div>
          </div>`;
      });
    }

    // 6) Renderiza Reflexão do Dia
    async function renderReflexao() {
      const data = await fetchData('reflexaododia.json'),
            c = document.getElementById('reflexao-container');
      if (!data) {
        c.innerHTML = '<p>Erro ao carregar reflexão.</p>';
        return;
      }
      const key = `${String(dia).padStart(2,'0')}/${String(mes+1).padStart(2,'0')}/${ano}`,
            r = data.find(x => x.data === key);
      c.innerHTML = '';
      if (!r) {
        c.innerHTML = '<p>Sem reflexão para hoje.</p>';
        return;
      }
      const card = document.createElement('div');
      card.className = 'reflexao-card';
      card.innerHTML = `
        <p class="reflexao-frase">"${r.frase}"</p>
        <p class="reflexao-autor">- ${r.autor}</p>
        <p class="reflexao-instrucao">Clique aqui para refletir</p>
        <div class="reflexao-extra">
          <p class="reflexao-texto">${r.reflexao}</p>
          <p class="reflexao-data">Reflexão: ${r.data}</p>
        </div>`;
      const extra = card.querySelector('.reflexao-extra'),
            instr = card.querySelector('.reflexao-instrucao');
      extra.style.display = 'none';
      instr.addEventListener('click', () => {
        extra.style.display = extra.style.display === 'none' ? 'block' : 'none';
      });
      c.appendChild(card);
    }

    // 7) Renderiza Aniversariantes + fogos de artifício
    async function renderAniversariantes() {
      const data = await fetchData('aniversariantes.json'),
            container = document.getElementById('aniversariantes-container');
      if (!data) {
        container.innerHTML = '<p>Erro ao carregar aniversariantes.</p>';
        return;
      }
      container.innerHTML = '';
      const hoje = new Date(),
            diaHoje = String(hoje.getDate()).padStart(2,'0'),
            mesHoje = String(hoje.getMonth()+1).padStart(2,'0'),
            nomesMes = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];

      data.forEach(a => {
        const [dStr,mStr] = a.data.split('/');
        const card = document.createElement('div');
        card.className = 'aniversariante-card';

        // se for hoje, marca e insere zona de fogos
        if (dStr === diaHoje && mStr === mesHoje) {
          card.classList.add('destaque-hoje');
          const tw = document.createElement('div');
          tw.className = 'twinkle-lights';
          card.appendChild(tw);
          setInterval(()=>spawnFirework(tw), 700);
        }

        const dataFmt = `${dStr} de ${nomesMes[Number(mStr)-1]}`;
        card.innerHTML += `
          <div class="aniversariante-img">
            ${a.imagem
              ? `<img src="${a.imagem}" alt="${a.nome}">`
              : '<i class="fas fa-birthday-cake"></i>'}
          </div>
          <div class="aniversariante-info">
            <h3><i class="fas fa-birthday-cake"></i> ${a.nome}</h3>
            ${a.cargo ? `<p>${a.cargo}</p>` : ''}
            <p class="aniversariante-data">${dataFmt}</p>
          </div>`;
        container.appendChild(card);
      });
    }

    // Cria um fogo de artifício com partículas aleatórias
    function spawnFirework(container) {
      const firework = document.createElement('div');
      firework.className = 'firework';
      firework.style.top  = (20 + Math.random()*60) + '%';
      firework.style.left = (20 + Math.random()*60) + '%';
      container.appendChild(firework);

      const particleCount = 12;
      for (let i = 0; i < particleCount; i++) {
        const p = document.createElement('div');
        p.className = 'firework-particle';
        const angle    = Math.random() * Math.PI * 2;
        const distance = 30 + Math.random()*70;
        p.style.setProperty('--dx', Math.cos(angle)*distance + 'px');
        p.style.setProperty('--dy', Math.sin(angle)*distance + 'px');
        const hue = Math.floor(Math.random()*360);
        const color = `hsl(${hue},100%,60%)`;
        p.style.background = color;
        p.style.boxShadow  = `0 0 8px ${color},0 0 16px ${color}`;
        firework.appendChild(p);
      }

      setTimeout(()=>firework.remove(), 1000);
    }

    // 8) Renderiza Férias
    async function renderFerias() {
      const data = await fetchData('ferias.json'),
            grid = document.getElementById('ferias-grid-container'),
            tb   = document.getElementById('ferias-tbody');
      if (!data) {
        grid.innerHTML = tb.innerHTML = '<p>Erro ao carregar férias.</p>';
        return;
      }
      grid.innerHTML = '';
      tb.innerHTML   = '';
      data.forEach(f => {
        grid.innerHTML += `
          <div class="ferias-card">
            <div class="ferias-card-header">
              <i class="fas fa-plane-departure ferias-card-icon"></i>
              <span class="ferias-card-colaborador">${f.colaborador}</span>
            </div>
            <div class="ferias-dates">
              <span class="ferias-card-inicio">${f.inicio}</span>
              <span class="ferias-card-retorno">${f.retorno}</span>
            </div>
            <p class="ferias-card-departamento">${f.departamento}</p>
          </div>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.colaborador}</td>
          <td>${f.departamento}</td>
          <td>${f.inicio}</td>
          <td>${f.retorno}</td>`;
        tb.appendChild(tr);
      });
    }

    // 9) Renderiza CIPA
    async function renderCIPA() {
      const raw = await fetchData('cipa.json'),
            c = document.getElementById('cipa-container');
      if (!raw) {
        c.innerHTML = '<p>Erro ao carregar CIPA.</p>';
        return;
      }
      c.innerHTML = '';
      const list = Array.isArray(raw) ? raw : Object.values(raw);
      list.forEach(i => {
        c.innerHTML += `
          <div class="cipa-card">
            <div class="cipa-icon"><i class="${i.icone}"></i></div>
            <h3>${i.titulo||i.nome}</h3>
            <p>${i.conteudo||i.cargo_cipa||''}</p>
          </div>`;
      });
    }

    // Inicializa o site com preloader
    initSite();
  });
  </script>
</body>
</html>
