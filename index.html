<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma"        content="no-cache" />
  <meta http-equiv="Expires"       content="0" />
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="favicon.png" type="image/png">
  <meta property="og:title" content="Portal PSR">
  <meta property="og:description" content="Acesse nosso canal interno com notícias, cardápio, aniversariantes e muito mais!">
  <meta property="og:image" content="https://i.postimg.cc/6QTrrhr6/thumbnail.jpg">
  <meta property="og:url" content="https://psrindustria.github.io/PortalPSR/">
  <meta property="og:type" content="website">
  <title>PortalPSR</title>
  <!-- CSS principal -->
  <link rel="stylesheet" href="style.css" />
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
</head>
<body>
  <!-- MENU (será carregado via JS) -->
  <div id="menu-placeholder"></div>

  <!-- BANNER -->
  <section class="banner" id="inicio">
    <h1>Bem-vindo ao PortalPSR</h1>
    <p>Aqui é o seu espaço. Aqui é PSR!</p> <!-- This will be updated by JS -->
    <a href="https://psrindustria.github.io/PortalPSR/cardapio.html" class="banner-btn">Cardápio da Semana</a>
  </section>

  <main>
    <!-- Novidades -->
    <section id="novidades" class="section">
      <h2 class="section-title">Novidades</h2>
      <div class="novidades-header">
        <i class="far fa-clock"></i>
        <span id="data-hoje-novidades"></span>
      </div>
      <div id="novidades-container" class="novidades-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Reflexão do Dia -->
    <section id="reflexao-do-dia" class="section">
      <h2 class="section-title">Reflexão do Dia</h2>
      <div id="reflexao-container" class="reflexao-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Aniversariantes -->
    <section id="aniversariantes" class="section">
      <h2 class="section-title">Aniversariantes do Mês</h2>
      <div id="aniversariantes-container" class="aniversariantes-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Férias -->
    <section id="ferias" class="section">
      <h2 class="section-title">Colaboradores em Férias</h2>
      <div class="ferias-container">
        <div id="ferias-grid-container" class="ferias-grid">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <table class="ferias-table">
          <thead>
            <tr>
              <th>Colaborador</th>
              <th>Departamento</th>
              <th>Início</th>
              <th>Retorno</th>
            </tr>
          </thead>
          <tbody id="ferias-tbody">
            <tr><td colspan="4"><div class="loading"><div class="loading-spinner"></div></div></td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- CIPA -->
    <section id="cipa" class="section">
      <h2 class="section-title">CIPA</h2>
      <div id="cipa-container" class="cipa-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>
  </main>

  <!-- FOOTER (será carregado via JS) -->
  <div id="footer-placeholder"></div>

  <!-- SCRIPTS -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Função para criar efeito de fogos de artifício
    function spawnFirework(container) {
      if (!container) return;
      const rect = container.getBoundingClientRect();
      const centerX = Math.random() * rect.width;
      const centerY = Math.random() * rect.height;

      const colors = ['#FF0000','#00FF00','#0000FF','#FFFF00','#FF00FF','#00FFFF'];
      const particleCount = 30;
      const speedMin = 1;
      const speedMax = 3;
      const gravity = 0.02;

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        const size = Math.floor(Math.random() * 4) + 3;

        Object.assign(particle.style, {
          position: 'absolute',
          width: `${size}px`,
          height: `${size}px`,
          backgroundColor: colors[Math.floor(Math.random() * colors.length)],
          borderRadius: '50%',
          left: `${centerX - size/2}px`,
          top: `${centerY - size/2}px`,
          opacity: '1',
          pointerEvents: 'none',
          transform: 'scale(1)'
        });

        container.appendChild(particle);

        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * (speedMax - speedMin) + speedMin;
        let vx = Math.cos(angle) * speed;
        let vy = Math.sin(angle) * speed;

        (function animate() {
          vy += gravity;
          const x = parseFloat(particle.style.left) + vx;
          const y = parseFloat(particle.style.top) + vy;
          particle.style.left = `${x}px`;
          particle.style.top  = `${y}px`;

          particle.style.opacity = parseFloat(particle.style.opacity) - 0.010;
          const currentScale = parseFloat(particle.style.transform.replace(/scale\(|\)/g, '')) || 1;
          particle.style.transform = `scale(${currentScale * 0.98})`;

          if (particle.style.opacity > 0) {
            requestAnimationFrame(animate);
          } else {
            if (particle.parentElement) {
                particle.parentElement.removeChild(particle);
            }
          }
        })();
      }
    }

    let fireworkIntervals = []; // Store all active interval IDs

    function clearAllFireworkIntervals() {
      fireworkIntervals.forEach(clearInterval);
      fireworkIntervals = [];
    }

    function startFireworkForElement(element) {
      if (!document.hidden) { // Only start if visible
        const intervalId = setInterval(() => {
          if (!document.hidden && element.closest('.destaque-hoje')) { // Ensure card is still highlighted and tab visible
            spawnFirework(element);
          }
        }, 700 + Math.random() * 300); // Add some randomness to interval
        fireworkIntervals.push(intervalId);
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        clearAllFireworkIntervals();
      } else {
        // Restart fireworks for all currently highlighted cards
        document.querySelectorAll('.destaque-hoje .twinkle-lights').forEach(tw => {
          startFireworkForElement(tw);
        });
      }
    });

    // 1) Injeta menu e rodapé
    ['menu','footer'].forEach(file => {
      fetch(`${file}.html?t=${Date.now()}`)
        .then(r => r.text())
        .then(html => {
          const placeholder = document.getElementById(`${file}-placeholder`);
          if (placeholder) placeholder.innerHTML = html;
          if (file === 'menu') {
            const toggle = document.getElementById('menu-toggle');
            const menuEl = document.getElementById('menu');
            if (toggle && menuEl) {
              toggle.addEventListener('click', () => {
                menuEl.classList.toggle('active');
              });
              menuEl.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                  menuEl.classList.remove('active');
                });
              });
            }
          }
        }).catch(e => console.error(`Error loading ${file}.html:`, e));
    });

    // 2) Configura data de hoje
    const hoje = new Date();
    const dia = hoje.getDate();
    const mes = hoje.getMonth();
    const ano = hoje.getFullYear();
    const meses = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
    const hojePt = `${dia} de ${meses[mes]} de ${ano}`;
    const dataHojeEl = document.getElementById('data-hoje-novidades');
    if (dataHojeEl) dataHojeEl.textContent = hojePt;

    // 3) Função genérica fetch + JSON com cache-buster
    async function fetchData(path) {
      const cacheBuster = Date.now();
      try {
        const res = await fetch(`${path}?t=${cacheBuster}`);
        if (!res.ok) throw new Error(`HTTP error ${res.status} for ${path}`);
        return await res.json();
      } catch(e) {
        console.error(`Failed to fetch ${path}:`, e);
        return null;
      }
    }
    
    // Função para carregar a mensagem dinâmica do banner
    async function renderDynamicBannerMessage() {
      try {
        // Assumes generate_header_message.py is run to create header_message.html
        const response = await fetch('header_message.html?t=' + Date.now()); 
        if (!response.ok) {
          throw new Error('Failed to load header_message.html');
        }
        const messageHtml = await response.text();
        const bannerParagraph = document.querySelector('.banner > p');
        if (bannerParagraph) {
          bannerParagraph.innerHTML = messageHtml;
        } else {
          const banner = document.querySelector('.banner');
          if (banner) {
            const h1 = banner.querySelector('h1');
            const newP = document.createElement('p');
            newP.innerHTML = messageHtml;
            // Insert after h1 or as first child if h1 not present
            if (h1 && h1.nextSibling) banner.insertBefore(newP, h1.nextSibling);
            else if (h1) banner.appendChild(newP);
            else banner.insertBefore(newP, banner.firstChild);
          }
        }
      } catch (error) {
        console.error('Error loading dynamic banner message:', error);
        const bannerParagraph = document.querySelector('.banner > p');
        if (bannerParagraph) {
            bannerParagraph.innerHTML = "Aqui é o seu espaço. Aqui é PSR!"; // Default message
        }
      }
    }

    // 4) Renderiza Novidades
    async function renderNovidades() {
      const data = await fetchData('novidades.json');
      const c = document.getElementById('novidades-container');
      if (!c) return;
      if (!data) {
        c.innerHTML = '<p>Erro ao carregar novidades.</p>';
        return;
      }
      c.innerHTML = '';
      data.forEach(n => {
        c.innerHTML += `
          <div class="novidade-card">
            <div class="novidade-img"><i class="${n.icone}"></i></div>
            <div class="novidade-content">
              <h3>${n.titulo}</h3>
              <div class="novidade-date"><i class="far fa-calendar-alt"></i> ${n.data}</div>
              <p>${n.conteudo||n.resumo||''}</p>
            </div>
          </div>`;
      });
    }

    // 5) Renderiza Reflexão do Dia
    async function renderReflexao() {
      const data = await fetchData('reflexaododia.json');
      const c = document.getElementById('reflexao-container');
      if (!c) return;
      if (!data) {
        c.innerHTML = '<p>Erro ao carregar reflexão.</p>';
        return;
      }
      const key = `${String(dia).padStart(2,'0')}/${String(mes+1).padStart(2,'0')}/${ano}`;
      const r = data.find(x => x.data === key);
      c.innerHTML = '';
      if (!r) {
        c.innerHTML = '<p>Sem reflexão para hoje.</p>';
        return;
      }
      const card = document.createElement('div');
      card.className = 'reflexao-card';
      card.innerHTML = `
        <p class="reflexao-frase">"${r.frase}"</p>
        <p class="reflexao-autor">- ${r.autor}</p>
        <p class="reflexao-instrucao">Clique aqui para refletir</p>
        <div class="reflexao-extra">
          <p class="reflexao-texto">${r.reflexao}</p>
          <p class="reflexao-data">Reflexão: ${r.data}</p>
        </div>`;
      const extra = card.querySelector('.reflexao-extra');
      const instr = card.querySelector('.reflexao-instrucao');
      if (extra) extra.style.display = 'none';
      if (instr) {
        instr.addEventListener('click', () => {
          if (extra) extra.style.display = extra.style.display === 'none' ? 'block' : 'none';
        });
      }
      c.appendChild(card);
    }

    // 6) Renderiza Aniversariantes + fogos de artifício
    async function renderAniversariantes() {
      const data = await fetchData('aniversariantes.json');
      const container = document.getElementById('aniversariantes-container');
      if (!container) return;
      if (!data) {
        container.innerHTML = '<p>Erro ao carregar aniversariantes.</p>';
        return;
      }
      container.innerHTML = '';
      clearAllFireworkIntervals(); // Clear previous intervals

      const hojeAtual = new Date();
      const diaHoje = String(hojeAtual.getDate()).padStart(2,'0');
      const mesHoje = String(hojeAtual.getMonth()+1).padStart(2,'0');
      const nomesMes = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];

      data.forEach(a => {
        const [dStr,mStr] = a.data ? a.data.split('/') : ['',''];
        const card = document.createElement('div');
        card.className = 'aniversariante-card';

        if (dStr === diaHoje && mStr === mesHoje) {
          card.classList.add('destaque-hoje');
          const tw = document.createElement('div');
          tw.className = 'twinkle-lights';
          card.appendChild(tw);
          startFireworkForElement(tw);
        }

        const dataFmt = (dStr && mStr && nomesMes[Number(mStr)-1]) ? `${dStr} de ${nomesMes[Number(mStr)-1]}` : 'Data inválida';
        
        const imgContainer = document.createElement('div');
        imgContainer.className = 'aniversariante-img';
        
        if (a.imagem) {
          const img = document.createElement('img');
          img.alt = a.nome || 'Aniversariante';
          img.onerror = function() {
            if (a.imagem_fallback) {
              this.onerror = function() { imgContainer.innerHTML = '<i class="fas fa-birthday-cake"></i>'; };
              this.src = a.imagem_fallback;
            } else {
              imgContainer.innerHTML = '<i class="fas fa-birthday-cake"></i>';
            }
          };
          img.src = a.imagem;
          imgContainer.appendChild(img);
        } else {
          imgContainer.innerHTML = '<i class="fas fa-birthday-cake"></i>';
        }
        card.appendChild(imgContainer);
        
        const infoDiv = document.createElement('div');
        infoDiv.className = 'aniversariante-info';
        infoDiv.innerHTML = `
          <h3><i class="fas fa-birthday-cake"></i> ${a.nome || 'Aniversariante'}</h3>
          ${a.cargo ? `<p>${a.cargo}</p>` : ''}
          <p class="aniversariante-data">${dataFmt}</p>
        `;
        card.appendChild(infoDiv);
        container.appendChild(card);
      });
    }

    // 7) Renderiza Férias
    async function renderFerias() {
      const data = await fetchData('ferias.json');
      const grid = document.getElementById('ferias-grid-container');
      const tb   = document.getElementById('ferias-tbody');
      if (!grid || !tb) return;

      if (!data) {
        grid.innerHTML = '<p>Erro ao carregar férias.</p>';
        tb.innerHTML = '<tr><td colspan="4"><p>Erro ao carregar férias.</p></td></tr>';
        return;
      }
      grid.innerHTML = '';
      tb.innerHTML   = '';
      if (data.length === 0) {
        grid.innerHTML = '<p>Nenhum colaborador em férias no momento.</p>';
        tb.innerHTML = '<tr><td colspan="4">Nenhum colaborador em férias no momento.</td></tr>';
        return;
      }
      data.forEach(f => {
        grid.innerHTML += `
          <div class="ferias-card">
            <div class="ferias-card-header">
              <i class="fas fa-plane-departure ferias-card-icon"></i>
              <span class="ferias-card-colaborador">${f.colaborador}</span>
            </div>
            <div class="ferias-dates">
              <span class="ferias-card-inicio">${f.inicio}</span>
              <span class="ferias-card-retorno">${f.retorno}</span>
            </div>
            <p class="ferias-card-departamento">${f.departamento}</p>
          </div>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.colaborador}</td>
          <td>${f.departamento}</td>
          <td>${f.inicio}</td>
          <td>${f.retorno}</td>`;
        tb.appendChild(tr);
      });
    }

    // 8) Renderiza CIPA
    async function renderCIPA() {
      const raw = await fetchData('cipa.json');
      const c = document.getElementById('cipa-container');
      if (!c) return;
      if (!raw) {
        c.innerHTML = '<p>Erro ao carregar CIPA.</p>';
        return;
      }
      c.innerHTML = '';
      const list = Array.isArray(raw) ? raw : (typeof raw === 'object' && raw !== null ? Object.values(raw) : []);
      if (list.length === 0) {
        c.innerHTML = '<p>Nenhuma informação da CIPA disponível.</p>';
        return;
      }
      list.forEach(i => {
        c.innerHTML += `
          <div class="cipa-card">
            <div class="cipa-icon"><i class="${i.icone || 'fas fa-shield-alt'}"></i></div>
            <h3>${i.titulo||i.nome||'Item CIPA'}</h3>
            <p>${i.conteudo||i.cargo_cipa||''}</p>
          </div>`;
      });
    }

    // 9) Dispara todas as renderizações
    renderDynamicBannerMessage();
    renderNovidades();
    renderReflexao();
    renderAniversariantes();
    renderFerias();
    renderCIPA();

  });
  </script>
</body>
</html>
