<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /> 
  <meta http-equiv="Pragma"        content="no-cache" />
  <meta http-equiv="Expires"       content="0" />  
  <title>PSR Indústria</title>
  <!-- CSS principal -->
  <link rel="stylesheet" href="style.css" />
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
</head>
<body>
  <!-- MENU (será carregado via JS) -->
  <div id="menu-placeholder"></div>

  <!-- BANNER -->
  <section class="banner" id="inicio">
    <h1>Bem-vindo à Intranet PSR Indústria</h1>
    <p>Sua fonte central de informações, notícias e recursos.</p>
    <a href="#novidades" class="banner-btn">Ver Novidades</a>
  </section>

  <main>
    <!-- Novidades -->
    <section id="novidades" class="section">
      <h2 class="section-title">Novidades</h2>
      <div class="novidades-header">
        <i class="far fa-clock"></i>
        <span id="data-hoje-novidades"></span>
      </div>
      <div id="novidades-container" class="novidades-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Reflexão do Dia -->
    <section id="reflexao-do-dia" class="section">
      <h2 class="section-title">Reflexão do Dia</h2>
      <div id="reflexao-container" class="reflexao-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Aniversariantes -->
    <section id="aniversariantes" class="section">
      <h2 class="section-title">Aniversariantes do Mês</h2>
      <div id="aniversariantes-container" class="aniversariantes-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>

    <!-- Férias -->
    <section id="ferias" class="section">
      <h2 class="section-title">Colaboradores em Férias</h2>
      <div class="ferias-container">
        <div id="ferias-grid-container" class="ferias-grid">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <table class="ferias-table">
          <thead>
            <tr>
              <th>Colaborador</th>
              <th>Departamento</th>
              <th>Início</th>
              <th>Retorno</th>
            </tr>
          </thead>
          <tbody id="ferias-tbody">
            <tr><td colspan="4"><div class="loading"><div class="loading-spinner"></div></div></td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- CIPA -->
    <section id="cipa" class="section">
      <h2 class="section-title">CIPA</h2>
      <div id="cipa-container" class="cipa-container">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </section>
  </main>

  <!-- FOOTER (será carregado via JS) -->
  <div id="footer-placeholder"></div>

  <!-- SCRIPTS -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) Injeta menu e rodapé
    ['menu','footer'].forEach(file => {
      fetch(`${file}.html`)
        .then(r => r.text())
        .then(html => document.getElementById(`${file}-placeholder`).innerHTML = html);
    });

    // 2) Configura data de hoje
    const hoje = new Date(),
          dia = hoje.getDate(),
          mes = hoje.getMonth(),
          ano = hoje.getFullYear(),
          meses = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'],
          hojePt = `${dia} de ${meses[mes]} de ${ano}`;
    document.getElementById('data-hoje-novidades').textContent = hojePt;

    // 3) Função genérica fetch + JSON com cache-buster
    async function fetchData(path) {
      const cacheBuster = Date.now();
      try {
        const res = await fetch(`${path}?t=${cacheBuster}`);
        if (!res.ok) throw new Error(res.status);
        return await res.json();
      } catch {
        return null;
      }
    }

    // 4) Renderiza Novidades
    async function renderNovidades() {
      const data = await fetchData('novidades.json'),
            c = document.getElementById('novidades-container');
      if (!data) {
        c.innerHTML = '<p>Erro ao carregar novidades.</p>';
        return;
      }
      c.innerHTML = '';
      data.forEach(n => {
        c.innerHTML += `
          <div class="novidade-card">
            <div class="novidade-img"><i class="${n.icone}"></i></div>
            <div class="novidade-content">
              <h3>${n.titulo}</h3>
              <div class="novidade-date"><i class="far fa-calendar-alt"></i> ${n.data}</div>
              <p>${n.conteudo||n.resumo}</p>
            </div>
          </div>`;
      });
    }

    // 5) Renderiza Reflexão do Dia
    async function renderReflexao() {
      const data = await fetchData('reflexaododia.json'),
            c = document.getElementById('reflexao-container');
      if (!data) {
        c.innerHTML = '<p>Erro ao carregar reflexão.</p>';
        return;
      }
      const key = `${String(dia).padStart(2,'0')}/${String(mes+1).padStart(2,'0')}/${ano}`,
            r = data.find(x => x.data === key);
      c.innerHTML = '';
      if (!r) {
        c.innerHTML = '<p>Sem reflexão para hoje.</p>';
        return;
      }
      const card = document.createElement('div');
      card.className = 'reflexao-card';
      card.innerHTML = `
        <p class="reflexao-frase">“${r.frase}”</p>
        <p class="reflexao-autor">- ${r.autor}</p>
        <p class="reflexao-instrucao">Clique aqui para refletir</p>
        <div class="reflexao-extra">
          <p class="reflexao-texto">${r.reflexao}</p>
          <p class="reflexao-data">Reflexão: ${r.data}</p>
        </div>`;
      const extra = card.querySelector('.reflexao-extra'),
            instr = card.querySelector('.reflexao-instrucao');
      extra.style.display = 'none';
      instr.addEventListener('click', () => {
        extra.style.display = extra.style.display === 'none' ? 'block' : 'none';
      });
      c.appendChild(card);
    }

    // 6) Renderiza Aniversariantes + fogos de artifício
    async function renderAniversariantes() {
      const data = await fetchData('aniversariantes.json'),
            container = document.getElementById('aniversariantes-container');
      if (!data) {
        container.innerHTML = '<p>Erro ao carregar aniversariantes.</p>';
        return;
      }
      container.innerHTML = '';
      const hoje = new Date(),
            diaHoje = String(hoje.getDate()).padStart(2,'0'),
            mesHoje = String(hoje.getMonth()+1).padStart(2,'0'),
            nomesMes = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];

      data.forEach(a => {
        const [dStr,mStr] = a.data.split('/');
        const card = document.createElement('div');
        card.className = 'aniversariante-card';

        // se for hoje, marca e insere zona de fogos
        if (dStr === diaHoje && mStr === mesHoje) {
          card.classList.add('destaque-hoje');
          const tw = document.createElement('div');
          tw.className = 'twinkle-lights';
          card.appendChild(tw);
          setInterval(()=>spawnFirework(tw), 700);
        }

        const dataFmt = `${dStr} de ${nomesMes[Number(mStr)-1]}`;
        card.innerHTML += `
          <div class="aniversariante-img">
            ${a.imagem
              ? `<img src="${a.imagem}" alt="${a.nome}">`
              : '<i class="fas fa-birthday-cake"></i>'}
          </div>
          <div class="aniversariante-info">
            <h3><i class="fas fa-birthday-cake"></i> ${a.nome}</h3>
            ${a.cargo ? `<p>${a.cargo}</p>` : ''}
            <p class="aniversariante-data">${dataFmt}</p>
          </div>`;
        container.appendChild(card);
      });
    }

    // cria um fogo de artifício com partículas aleatórias
    function spawnFirework(container) {
      const firework = document.createElement('div');
      firework.className = 'firework';
      firework.style.top  = (20 + Math.random()*60) + '%';
      firework.style.left = (20 + Math.random()*60) + '%';
      container.appendChild(firework);

      const particleCount = 12;
      for (let i = 0; i < particleCount; i++) {
        const p = document.createElement('div');
        p.className = 'firework-particle';
        const angle    = Math.random() * Math.PI * 2;
        const distance = 30 + Math.random()*70;
        p.style.setProperty('--dx', Math.cos(angle)*distance + 'px');
        p.style.setProperty('--dy', Math.sin(angle)*distance + 'px');
        const hue = Math.floor(Math.random()*360);
        const color = `hsl(${hue},100%,60%)`;
        p.style.background = color;
        p.style.boxShadow  = `0 0 8px ${color},0 0 16px ${color}`;
        firework.appendChild(p);
      }

      setTimeout(()=>firework.remove(), 1000);
    }

    // 7) Renderiza Férias
    async function renderFerias() {
      const data = await fetchData('ferias.json'),
            grid = document.getElementById('ferias-grid-container'),
            tb   = document.getElementById('ferias-tbody');
      if (!data) {
        grid.innerHTML = tb.innerHTML = '<p>Erro ao carregar férias.</p>';
        return;
      }
      grid.innerHTML = '';
      tb.innerHTML   = '';
      data.forEach(f => {
        grid.innerHTML += `
          <div class="ferias-card">
            <div class="ferias-card-header">
              <i class="fas fa-plane-departure ferias-card-icon"></i>
              <span class="ferias-card-colaborador">${f.colaborador}</span>
            </div>
            <div class="ferias-dates">
              <span class="ferias-card-inicio">${f.inicio}</span>
              <span class="ferias-card-retorno">${f.retorno}</span>
            </div>
            <p class="ferias-card-departamento">${f.departamento}</p>
          </div>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.colaborador}</td>
          <td>${f.departamento}</td>
          <td>${f.inicio}</td>
          <td>${f.retorno}</td>`;
        tb.appendChild(tr);
      });
    }

    // 8) Renderiza CIPA
    async function renderCIPA() {
      const raw = await fetchData('cipa.json'),
            c = document.getElementById('cipa-container');
      if (!raw) {
        c.innerHTML = '<p>Erro ao carregar CIPA.</p>';
        return;
      }
      c.innerHTML = '';
      const list = Array.isArray(raw) ? raw : Object.values(raw);
      list.forEach(i => {
        c.innerHTML += `
          <div class="cipa-card">
            <div class="cipa-icon"><i class="${i.icone}"></i></div>
            <h3>${i.titulo||i.nome}</h3>
            <p>${i.conteudo||i.cargo_cipa||''}</p>
          </div>`;
      });
    }

    // 9) Dispara todas as renderizações
    renderNovidades();
    renderReflexao();
    renderAniversariantes();
    renderFerias();
    renderCIPA();
  });
  </script>
</body>
</html>
