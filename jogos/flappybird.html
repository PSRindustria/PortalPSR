<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>FlapBobina - Mobile Fix</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
        --azul-marinho: #003366;
        --azul-ceu-claro: #a0d9ff;
        --dourado: #DAA520;
        --verde-sucesso: #28a745;
        --branco: #FFFFFF;
        --papelao-escuro: #5d4037;
        --papelao-claro: #d7ccc8;
    }

    body {
      margin: 0; padding: 0;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(180deg, #87CEEB 0%, #a0d9ff 50%, #E0F6FF 100%);
      touch-action: none;
      user-select: none;
    }

    canvas { display: block; width: 100%; height: 100%; }

    /* UI LAYER */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
    }

    .hud-score {
      position: absolute; top: 10%;
      font-size: 4rem; font-weight: 700;
      color: var(--branco);
      text-shadow: 4px 4px 0px rgba(0,51,102,0.4), 
                   0 0 20px rgba(218,165,32,0.5);
      z-index: 10;
      animation: scoreFloat 2s ease-in-out infinite;
    }

    @keyframes scoreFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }

    .btn-start {
      pointer-events: auto;
      background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
      color: var(--azul-marinho);
      font-size: 1.5rem; font-weight: 700;
      padding: 15px 40px; border: none; border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(218,165,32,0.4),
                  0 0 0 3px rgba(255,255,255,0.3);
      display: flex; align-items: center; gap: 10px;
      animation: pulse 2s infinite;
      text-transform: uppercase; letter-spacing: 1px;
      transition: all 0.3s ease;
    }
    .btn-start:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(218,165,32,0.5),
                  0 0 0 3px rgba(255,255,255,0.5);
    }
    .btn-start:active { transform: scale(0.96); }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* === MODAL CORRIGIDO PARA MOBILE === */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 51, 102, 0.95);
      backdrop-filter: blur(10px); z-index: 100;
      display: none; 
      justify-content: center; 
      align-items: center;
      pointer-events: auto; 
      padding: 20px;
      box-sizing: border-box;
    }

    .modal-content {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      width: 100%; 
      max-width: 360px;
      border-radius: 25px; 
      padding: 25px 20px; 
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5),
                  0 0 0 3px rgba(218,165,32,0.3);
      border-top: 8px solid var(--dourado);
      animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      
      max-height: 90vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    @keyframes slideIn {
        from { transform: scale(0.7) rotate(-5deg); opacity: 0; }
        to { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .modal-title { 
      color: var(--azul-marinho); 
      font-size: 1.6rem; 
      margin: 0 0 5px 0; 
      font-weight: 800;
      text-shadow: 2px 2px 0px rgba(218,165,32,0.2);
    }
    
    .final-score { 
      font-size: 4rem; 
      color: var(--dourado); 
      font-weight: 800; 
      line-height: 1; 
      margin-bottom: 20px; 
      text-shadow: 3px 3px 0px rgba(0,51,102,0.2);
      animation: scorePopIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes scorePopIn {
      0% { transform: scale(0); }
      70% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .input-group { text-align: left; margin-bottom: 15px; }
    .input-group label { 
      display: block; 
      color: #555; 
      font-size: 0.85rem; 
      margin-bottom: 5px; 
      font-weight: 700; 
    }
    .input-group input { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #ddd; 
      border-radius: 12px; 
      font-family: inherit; 
      font-size: 1rem; 
      outline: none; 
      box-sizing: border-box; 
      transition: 0.3s;
      background: white;
    }
    .input-group input:focus { 
      border-color: var(--dourado);
      box-shadow: 0 0 0 3px rgba(218,165,32,0.1);
    }

    .btn-action { 
      width: 100%; 
      padding: 14px; 
      border: none; 
      border-radius: 12px; 
      font-size: 1rem; 
      font-weight: 700; 
      cursor: pointer; 
      margin-bottom: 10px; 
      transition: all 0.3s ease; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
    }
    
    .btn-primary { 
      background: linear-gradient(135deg, #003366 0%, #004080 100%);
      color: white; 
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, #002244 0%, #003366 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,51,102,0.3);
    }
    
    .btn-secondary { 
      background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
      color: #666; 
    }
    .btn-secondary:hover { 
      background: linear-gradient(135deg, #e8e8e8 0%, #dadada 100%);
      transform: translateY(-2px);
    }

    .btn-tertiary {
        background: transparent;
        color: #999;
        font-size: 0.85rem;
        margin-top: 5px;
        font-weight: 500;
        padding: 10px;
        width: 100%;
        border: none;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    .btn-tertiary:hover {
      color: #666;
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <canvas id="gameCanvas"></canvas>

  <div id="ui-layer">
    <div id="score-display" class="hud-score hidden">0</div>
    <button id="start-btn" class="btn-start hidden"><i class="fas fa-play"></i> JOGAR</button>
    <div id="loading-msg" style="font-weight: bold; color: var(--azul-marinho); font-size: 1.2rem; text-shadow: 2px 2px 4px rgba(255,255,255,0.8);">Carregando Bobina...</div>
  </div>

  <div id="modal-gameover" class="modal-overlay">
    <div class="modal-content">
      <h2 class="modal-title">Fim de Jogo!</h2>
      <p style="color: #777; margin: 0 0 10px 0; font-size: 0.9rem;">Sua pontuação final:</p>
      <div id="final-score-val" class="final-score">0</div>

      <div id="save-score-area">
          <div class="input-group">
              <label>Seu Nome (Rank):</label>
              <input type="text" id="player-name" placeholder="Ex: Ana (RH)" maxlength="20">
          </div>
          <button id="btn-save" class="btn-action btn-primary">Salvar Pontuação</button>
      </div>
      
      <div id="msg-success" style="display:none; color: var(--verde-sucesso); margin-bottom: 20px; font-weight: 700; font-size: 1.1rem;">
          <i class="fas fa-check-circle"></i> Salvo com sucesso!
      </div>

      <button id="btn-restart" class="btn-action btn-secondary"><i class="fas fa-redo"></i> Tentar Novamente</button>
      
      <button id="btn-back" class="btn-tertiary">Voltar para a ConexãoPSR</button>
    </div>
  </div>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBzMvAw9ahEyd-tSYY08HxcMzo9RKf3IFY",
      authDomain: "jornalpsr-1b8c6.firebaseapp.com",
      databaseURL: "https://jornalpsr-1b8c6-default-rtdb.firebaseio.com",
      projectId: "jornalpsr-1b8c6",
  };

  firebase.initializeApp(firebaseConfig);
  let AUTH_TOKEN = null;

  firebase.auth().signInAnonymously()
      .then(u => u.user.getIdToken())
      .then(token => {
          AUTH_TOKEN = token;
          console.log("Jogo conectado com segurança!");
      })
      .catch(e => console.error("Erro no login do jogo:", e));

  async function secureFetch(url, options = {}) {
      if (!AUTH_TOKEN) {
          alert("Erro de Segurança: O jogo ainda não conectou ao servidor. Tente novamente em alguns segundos.");
          throw new Error("Sem token");
      }
      const separator = url.includes('?') ? '&' : '?';
      return fetch(`${url}${separator}auth=${AUTH_TOKEN}`, options);
  }
    const FIREBASE_URL = "https://jornalpsr-1b8c6-default-rtdb.firebaseio.com/games/FlapBobina/scores.json";
    const CHARACTER_IMG_URL = "https://i.postimg.cc/k5gYjdCG/Bobinasv2-(1).png";
    const PORTAL_URL = "https://psrindustria.github.io/PortalPSR/jornal.html";
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const TIME_STEP = 1000 / 60; 
    let accumulatedTime = 0;
    let lastTime = 0;

    let frames = 0; 
    let score = 0;
    let gameRunning = false;
    
    const START_SPEED = 3.0; 
    const MAX_SPEED = 9.0;  
    const IMPOSSIBLE_AT_SCORE = 125; 
    const SPEED_INCREMENT = (MAX_SPEED - START_SPEED) / IMPOSSIBLE_AT_SCORE;
    
    let currentSpeed = START_SPEED;

    const uiStartBtn = document.getElementById('start-btn');
    const loadingMsg = document.getElementById('loading-msg');
    const uiScore = document.getElementById('score-display');
    const modalGameOver = document.getElementById('modal-gameover');
    const finalScoreEl = document.getElementById('final-score-val');
    const btnSave = document.getElementById('btn-save');
    const btnRestart = document.getElementById('btn-restart');
    const btnBack = document.getElementById('btn-back');
    const inputName = document.getElementById('player-name');
    const msgSuccess = document.getElementById('msg-success');
    const saveArea = document.getElementById('save-score-area');

    const birdImage = new Image();
    birdImage.src = CHARACTER_IMG_URL;
    birdImage.onload = function() {
        loadingMsg.classList.add('hidden');
        uiStartBtn.classList.remove('hidden');
        resizeCanvas();
    };

    const particles = [];
    const clouds = [];
    
    class Cloud {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * (canvas.height * 0.4);
            this.size = Math.random() * 60 + 40;
            this.speed = Math.random() * 0.3 + 0.1;
            this.opacity = Math.random() * 0.3 + 0.2;
        }
        update() {
            this.x -= this.speed;
            if (this.x + this.size < 0) {
                this.x = canvas.width + this.size;
                this.y = Math.random() * (canvas.height * 0.4);
            }
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.opacity;
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size * 0.6, 0, Math.PI * 2);
            ctx.arc(this.x + this.size * 0.4, this.y - this.size * 0.2, this.size * 0.5, 0, Math.PI * 2);
            ctx.arc(this.x + this.size * 0.8, this.y, this.size * 0.6, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
    }
    
    for (let i = 0; i < 5; i++) {
        clouds.push(new Cloud());
    }

    class Particle {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.size = Math.random() * 12 + 6; 
            this.speedX = -Math.random() * 3 - 2; 
            this.speedY = Math.random() * 3 + 1; 
            this.life = 1.0;
            this.rotation = Math.random() * Math.PI * 2;
            this.rotationSpeed = (Math.random() - 0.5) * 0.2;
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            this.speedY += 0.15;
            this.size *= 0.92; 
            this.life -= 0.04;
            this.rotation += this.rotationSpeed;
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.life * 0.8;
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            
            const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.size);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(0.5, 'rgba(200, 200, 255, 0.8)');
            gradient.addColorStop(1, 'rgba(160, 217, 255, 0.3)');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(0, 0, this.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
    }

    function spawnSmoke(x, y) {
        for (let i = 0; i < 6; i++) {
            particles.push(new Particle(x + Math.random() * 20 - 10, y + Math.random() * 10));
        }
    }

    const bird = {
        x: 50, y: 150, width: 40, height: 50,
        velocity: 0,
        gravity: 0.23, 
        lift: -5.2,    
        rotation: 0,
        bobOffset: 0,
        bobSpeed: 0.08,

        draw() {
            ctx.save();
            
            if (!gameRunning) {
                this.bobOffset += this.bobSpeed;
                const bobY = Math.sin(this.bobOffset) * 8;
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2 + bobY);
            } else {
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
            }
            
            ctx.rotate(this.rotation);
            
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 15;
            ctx.shadowOffsetX = 5;
            ctx.shadowOffsetY = 5;
            
            ctx.drawImage(birdImage, -this.width / 2, -this.height / 2, this.width, this.height);
            ctx.restore();
        },

        update() {
            this.velocity += this.gravity;
            this.y += this.velocity;

            if (this.velocity < 0) {
                this.rotation = Math.max(this.rotation - 0.1, -0.3); 
            } else {
                this.rotation = Math.min(this.rotation + 0.06, 0.5);
            }

            if (this.y + this.height >= canvas.height - fg.h) {
                this.y = canvas.height - fg.h - this.height;
                gameOver();
            }
            if(this.y < 0) {
                this.y = 0;
                this.velocity = 0;
            }
        },

        flap() {
            this.velocity = this.lift;
            spawnSmoke(this.x, this.y + this.height - 10);
        },
        
        reset() {
            this.x = canvas.width * 0.2;
            if(this.x > 150) this.x = 150; 
            this.y = canvas.height / 2;
            this.velocity = 0;
            this.rotation = 0;
            this.bobOffset = 0;
        }
    };

    const bg = {
        draw() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.5, '#a0d9ff');
            gradient.addColorStop(1, '#E0F6FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = "rgba(255, 255, 100, 0.9)";
            ctx.shadowColor = "rgba(255, 255, 100, 0.5)";
            ctx.shadowBlur = 30;
            ctx.beginPath();
            ctx.arc(canvas.width - 100, 80, 35, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            for (let cloud of clouds) {
                cloud.draw();
            }
        }
    };

    const fg = {
        h: 80,
        draw() {
            const gradient = ctx.createLinearGradient(0, canvas.height - this.h, 0, canvas.height);
            gradient.addColorStop(0, '#004080');
            gradient.addColorStop(1, '#003366');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, canvas.height - this.h, canvas.width, this.h);
            
            const goldGradient = ctx.createLinearGradient(0, canvas.height - this.h, 0, canvas.height - this.h + 8);
            goldGradient.addColorStop(0, '#FFD700');
            goldGradient.addColorStop(1, '#DAA520');
            ctx.fillStyle = goldGradient;
            ctx.fillRect(0, canvas.height - this.h, canvas.width, 8);
            
            ctx.fillStyle = "rgba(255, 215, 0, 0.2)";
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.fillRect(i, canvas.height - this.h + 10, 2, this.h - 10);
            }
        }
    };

    const pipes = {
        position: [],
        w: 70, 
        gap: 170, 
        spawnTimer: 0, 

        drawTubete(x, y, width, height, isTop) {
            ctx.save();
            
            let gradient = ctx.createLinearGradient(x, 0, x + width, 0);
            gradient.addColorStop(0, "#4a3728");
            gradient.addColorStop(0.15, "#6d4c41");
            gradient.addColorStop(0.5, "#a1887f");
            gradient.addColorStop(0.85, "#6d4c41");
            gradient.addColorStop(1, "#4a3728");
            
            ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 5;
            
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, width, height);
            
            ctx.fillStyle = "rgba(62, 39, 35, 0.3)";
            for (let i = y; i < y + height; i += 20) {
                ctx.fillRect(x + 5, i, width - 10, 2);
            }
            
            let rimGradient = ctx.createLinearGradient(x, 0, x + width, 0);
            rimGradient.addColorStop(0, "#3e2723");
            rimGradient.addColorStop(0.5, "#5d4037");
            rimGradient.addColorStop(1, "#3e2723");
            ctx.fillStyle = rimGradient;
            
            let rimHeight = 18;
            if(isTop) {
                ctx.fillRect(x - 4, y + height - rimHeight, width + 8, rimHeight);
                ctx.fillStyle = "rgba(0, 0, 0, 0.3)";
                ctx.fillRect(x - 4, y + height - 3, width + 8, 3);
            } else {
                ctx.fillRect(x - 4, y, width + 8, rimHeight);
                ctx.fillStyle = "rgba(255, 255, 255, 0.1)";
                ctx.fillRect(x - 4, y, width + 8, 3);
            }
            
            ctx.restore();
        },

        draw() {
            for(let i = 0; i < this.position.length; i++){
                let p = this.position[i];
                let topY = p.y;
                let bottomY = p.y + this.gap;
                this.drawTubete(p.x, 0, this.w, topY, true);
                this.drawTubete(p.x, bottomY, this.w, canvas.height - bottomY - fg.h, false);
            }
        },

        spawnPipe(xOverride) {
            const padding = 60; 
            const maxYGlobal = canvas.height - fg.h - this.gap - padding; 
            const minYGlobal = padding; 

            let y;
            if (this.position.length === 0) {
                y = Math.floor(maxYGlobal / 2); 
            } else {
                const lastY = this.position[this.position.length - 1].y;
                const maxStep = 200; 
                let minSafe = Math.max(minYGlobal, lastY - maxStep);
                let maxSafe = Math.min(maxYGlobal, lastY + maxStep);
                y = Math.floor(Math.random() * (maxSafe - minSafe + 1) + minSafe);
            }

            const x = xOverride !== undefined ? xOverride : canvas.width;
            this.position.push({ x: x, y: y, passed: false });
        },

        update() {
            currentSpeed = START_SPEED + (score * SPEED_INCREMENT);
            if(currentSpeed > MAX_SPEED) currentSpeed = MAX_SPEED;

            const maxFramesGap = 110; 
            const minFramesGap = 70;  
            let targetFrames = maxFramesGap - ((maxFramesGap - minFramesGap) * (score / IMPOSSIBLE_AT_SCORE));
            if(targetFrames < minFramesGap) targetFrames = minFramesGap;

            this.spawnTimer++;
            if(this.spawnTimer >= targetFrames) {
                this.spawnTimer = 0;
                this.spawnPipe();
            }

            for(let i = 0; i < this.position.length; i++){
                let p = this.position[i];
                p.x -= currentSpeed; 

                const tolerance = 10; 
                if (bird.x + bird.width - tolerance > p.x && bird.x + tolerance < p.x + this.w) {
                    if (bird.y + tolerance < p.y || bird.y + bird.height - tolerance > p.y + this.gap) {
                        gameOver();
                    }
                }

                if(p.x + this.w < bird.x && !p.passed) {
                    score++;
                    uiScore.innerText = score;
                    p.passed = true;
                }

                if(p.x + this.w <= 0) {
                    this.position.shift();
                    i--;
                }
            }
        },
        reset() { 
            this.position = []; 
            this.spawnTimer = 0;
            this.spawnPipe(canvas.width + 100); 
        }
    };

    function loop(timestamp) {
        if (!gameRunning) return;
        requestAnimationFrame(loop);
        let deltaTime = timestamp - lastTime;
        lastTime = timestamp;
        if (deltaTime > 100) deltaTime = 100;
        accumulatedTime += deltaTime;
        while (accumulatedTime >= TIME_STEP) {
            updatePhysics();
            accumulatedTime -= TIME_STEP;
        }
        draw();
    }

    function updatePhysics() {
        for (let cloud of clouds) {
            cloud.update();
        }
        
        for (let i = 0; i < particles.length; i++) {
            particles[i].update();
            if (particles[i].life <= 0) {
                particles.splice(i, 1);
                i--;
            }
        }
        pipes.update();
        bird.update();
        frames++; 
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        bg.draw();
        pipes.draw();
        fg.draw();
        for (let i = 0; i < particles.length; i++) {
            particles[i].draw();
        }
        bird.draw();
    }

    function drawReadyState() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        bg.draw();
        fg.draw();
        if(birdImage.complete) bird.draw();
        
        ctx.fillStyle = "#003366";
        ctx.font = "700 24px Poppins";
        ctx.textAlign = "center";
        ctx.shadowColor = "rgba(255, 255, 255, 0.8)";
        ctx.shadowBlur = 10;
        ctx.fillText("Toque ou Espaço para voar", canvas.width/2, canvas.height/2 + 80);
        ctx.shadowBlur = 0;
    }

    function startGame() {
        if (gameRunning) return;
        uiStartBtn.classList.add('hidden');
        uiScore.classList.remove('hidden');
        uiScore.innerText = "0";
        bird.reset();
        pipes.reset();
        particles.length = 0;
        score = 0;
        frames = 0;
        currentSpeed = START_SPEED; 
        gameRunning = true;
        lastTime = performance.now();
        accumulatedTime = 0;
        requestAnimationFrame(loop);
    }

    function gameOver() {
        gameRunning = false;
        uiScore.classList.add('hidden');
        finalScoreEl.innerText = score;
        modalGameOver.style.display = 'flex';
        msgSuccess.style.display = 'none';
        saveArea.style.display = 'block';
        btnSave.disabled = false;
        btnSave.innerText = "Salvar Pontuação";
        
        if(localStorage.getItem('psr_player_name_flap')) {
            inputName.value = localStorage.getItem('psr_player_name_flap');
        }
    }

    function handleInput(e) {
        e.preventDefault();
        if (gameRunning) {
            bird.flap();
        } else if (modalGameOver.style.display === 'none' && uiStartBtn.classList.contains('hidden')) {
            startGame();
        }
    }

    canvas.addEventListener('mousedown', (e) => {
        if(modalGameOver.style.display === 'flex') return;
        handleInput(e);
    });
    
    canvas.addEventListener('touchstart', (e) => {
        if(modalGameOver.style.display === 'flex') return;
        handleInput(e);
    }, {passive: false});
    
    window.addEventListener('keydown', (e) => {
        if(e.code === 'Space') {
            if(gameRunning) bird.flap();
            else if(modalGameOver.style.display === 'none') startGame();
        }
    });

    uiStartBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        startGame();
    });

    uiStartBtn.addEventListener('touchend', (e) => {
        e.stopPropagation();
        e.preventDefault();
        startGame();
    });

    btnRestart.addEventListener('click', () => {
        modalGameOver.style.display = 'none';
        bird.reset();
        pipes.reset();
        drawReadyState();
        uiStartBtn.classList.remove('hidden');
    });

    btnBack.addEventListener('click', () => {
        window.location.href = PORTAL_URL;
    });

    btnSave.addEventListener('click', async () => {
        const name = inputName.value.trim();
        if(!name || name.length < 2) { alert("Digite um nome válido."); return; }
        localStorage.setItem('psr_player_name_flap', name);

        const payload = { nome: name, pontos: score, data: new Date().toLocaleString('pt-BR') };
        btnSave.disabled = true; btnSave.innerText = "Enviando...";

        try {
            await secureFetch(FIREBASE_URL, { method: 'POST', body: JSON.stringify(payload) });
            saveArea.style.display = 'none';
            msgSuccess.style.display = 'block';
        } catch (error) {
            console.error(error);
            alert("Erro de conexão.");
            btnSave.disabled = false;
            btnSave.innerText = "Tentar Novamente";
        }
    });

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if(!gameRunning) {
            bird.reset();
            drawReadyState();
        }
    }
    window.addEventListener('resize', resizeCanvas);

  </script>
</body>

</html>
